<!DOCTYPE html>
<!-- 认证资料 -->
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"
  />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <script type="text/javascript" charset="utf-8" src="../../script/flexible.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/api.js"></script>
  <title>认证资料</title>
  <link rel="stylesheet" type="text/css" href="../../css/aui.css">
  <link rel="stylesheet" type="text/css" href="../../css/aui-extends.css">
  <script type="text/javascript" charset="utf-8" src="../../iconfont/iconfont.js"></script>
</head>

<body class="renzheng">
  <header class="relative">
    <div class="header-wrap relative text-write background-transparent">
      <div class="title aui-text-center font-size-35">认证中心</div>
    </div>
    <div class="header-content-wrap aui-text-center font-size-38">
      <div class="header-content text-write">
        <span>已经完成</span>
        <span class="header-content-step font-size-50 text-blue" id="current-step">0</span>
        <span>项认证</span>
      </div>
    </div>
    <!-- <div class="header-note absolute background-write aui-text-center font-size-28">实名通过后才能继续其他认证，还可以拿新手福利</div> -->
    <div class="bg absolute">
      <img class="bg-image" src="../../image/certification-bg.png">
    </div>
  </header>
  <section class="aui-grid certification-content background-write">
    <div class="aui-row">
      <div class="aui-col-xs-6" onclick="javascript: goToCertification('gerenxinxi');">
        <div class="certification-logo" id="step-1">
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#icon-shenfenzhengxinxi-dan" data-name="shenfenzhengxinxi" id="icon-1"></use>
          </svg>
          <svg class="icon sign " aria-hidden="true">
            <use xlink:href="#icon-renzhengtongguo"></use>
          </svg>
        </div>
        <div class="aui-grid-label font-size-30 text-gray certification-title" id="text-1">个人信息认证</div>
      </div>
      <div class="aui-col-xs-6" onclick="javascript: goToCertification('lianxiren');">
        <div class="certification-logo" id="step-2">
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#icon-renzhenglianxiren-dan" data-name="renzhenglianxiren" id="icon-2"></use>
          </svg>
          <svg class="icon sign" aria-hidden="true">
            <use xlink:href="#icon-renzhengtongguo"></use>
          </svg>
        </div>
        <div class="aui-grid-label font-size-30 text-gray certification-title" id="text-2">联系人认证</div>
      </div>
      <div class="aui-col-xs-6" onclick="javascript: goToCertification('zhimafen');">
        <div class="certification-logo" id="step-3">
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#icon-zhimafen-dan" data-name="zhimafen" id="icon-3"></use>
          </svg>
          <svg class="icon sign" aria-hidden="true">
            <use xlink:href="#icon-renzhengtongguo"></use>
          </svg>
        </div>
        <div class="aui-grid-label font-size-30 text-gray certification-title" id="text-3">芝麻分认证</div>
      </div>
      <div class="aui-col-xs-6" onclick="javascript: goToCertification('yunyingshang');">
        <div class="certification-logo" id="step-4">
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#icon-yunyingshang-dan" data-name="yunyingshang" id="icon-4"></use>
          </svg>
          <svg class="icon sign" aria-hidden="true">
            <use xlink:href="#icon-renzhengtongguo"></use>
          </svg>
        </div>
        <div class="aui-grid-label font-size-30 text-gray certification-title" id="text-4">运营商认证</div>
      </div>
    </div>
  </section>
  <script type="text/javascript" charset="utf-8" src="../../script/global/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/base.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/router.js"></script>

  <script type="text/javascript">
    var User = null;
    var unauthorizedArr = [];
    var currentIndex = 0;
    apiready = function () {
      setListener();
      init();
    };

    function init() {
      User = $api.getStorage('User');
      if (checkNetwork() && checkLogin()) {
        sendRequest({
          url: 'GetCurrentStep',
          values: {
            deviceId: api.deviceId,
            phone: User.Phone
          },
          success: function (data) {
            alert(data);
            data = formatData(data);
            User = $api.getStorage('User');
            User.Step = data;
            $api.setStorage('User', User);
          },
          default: function () {
            setAllProgressStatus(User.Step);
          }
        });
      } else {
        setAllProgressStatus(User.Step);
      }
    }

    function setAllProgressStatus(stepArr) {
      var count = 0;
      var mark = true;
      for (var i = 0; i < 4; i++) {
        if (stepArr[i]) {
          count++;
          $api.addCls('step-' + (i + 1), 'selected');
          var dataName = $api.attr('icon-' + (i + 1), 'data-name');
          $api.attr('icon-' + (i + 1), 'xlink:href', '#icon-' + dataName + '-shen');
          $api.removeCls('text-' + (i + 1), 'text-gray');
          $api.addCls('text-' + (i + 1), 'text-black');
        } else {
          if (mark) {
            try {
              $api.addCls('step-' + (i + 1), 'active');
            } catch (e) {}
            mark = false;
          }
          unauthorizedArr.push(i + 1);
        }
      }
      $api.html('current-step', count);
    }

    function setSingleProgressStatus() {
      User = $api.getStorage('User');
      var mark = true;
      var count = $api.text('current-step') * 1;
      var dataName = $api.attr('icon-' + currentIndex, 'data-name');
      $api.addCls('step-' + currentIndex, 'selected');
      $api.attr('icon-' + currentIndex, 'xlink:href', '#icon-' + dataName + '-shen');
      $api.removeCls('text-' + currentIndex, 'text-gray');
      $api.addCls('text-' + currentIndex, 'text-black');
      for (var i = 0; i < 4; i++) {
        if (!User.Step[i] && mark) {
          $api.addCls('step-' + (i + 1), 'active');
          mark = false;
        }
      }
      $api.html('current-step', count + 1);
    }

    function goToCertification(page) {
      var nameArr = ['个人信息认证', '联系人认证', '芝麻分认证', '运营商认证'];
      var nameJson = {
        gerenxinxi: {
          step: 1,
          name: '个人信息认证'
        },
        lianxiren: {
          step: 2,
          name: '联系人认证'
        },
        zhimafen: {
          step: 3,
          name: '芝麻分认证'
        },
        yunyingshang: {
          step: 4,
          name: '运营商认证'
        }
      };
      if ($api.hasCls('step-' + nameJson[page].step, 'selected')) {
        alertMsg(nameJson[page].name + '已认证！');
        return false;
      } else if (unauthorizedArr.length > 0 && nameJson[page].step > unauthorizedArr[0]) {
        alertMsg('请先完成' + nameArr[unauthorizedArr[0] - 1] + '!');
        return false;
      }
      currentIndex = nameJson[page].step;
      openFormwork(page);
    }

    function setListener() {
      api.addEventListener({
          name: 'ChangeStep'
        },
        function (ret, err) {
          if (ret) {
            setSingleProgressStatus(ret.value.step);
            User = $api.getStorage('User');
            User.Step = ret.value.step;
            $api.setStorage('User', User);
            unauthorizedArr.shift();
          }
        }
      );
      api.addEventListener({
          name: 'Login'
        },
        function (ret, err) {
          if (ret) init();
        }
      );
      api.addEventListener({
          name: 'Refresh'
        },
        function (ret, err) {
          if (ret) {
            if (ret.value.goal === 'renzheng') {
              init();
            }
          }
        }
      );
      api.addEventListener({
          name: 'online'
        },
        function (ret, err) {
          if (ret) init();
        }
      );
      api.addEventListener({
          name: 'CloseCertification'
        },
        function (ret, err) {
          if (ret) {
            User = $api.getStorage('User');
            User.Step[3] = true;
            $api.setStorage('User', User);
            setSingleProgressStatus();
          }
        }
      );
    }

    function formatData(data) {
      var content = [];
      for (var i = 0; i < 4; i++) {
        content.push(data['Step' + (i + 1)]);
      }
      return content;
    }
  </script>
</body>

</html>